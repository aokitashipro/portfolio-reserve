# language: ja

Feature: マイページ - 予約管理
  ユーザーとして予約の確認・変更・キャンセルをしたい

  Background:
    Given ユーザーがログインしている
    And マイページにアクセスしている

  # 基本表示
  Scenario: マイページにアクセスする
    Then ページタイトルに「マイページ」が表示される
    And 「予約の確認・変更・キャンセルができます」という説明が表示される

  Scenario: ステータスフィルタタブが表示される
    Then 「すべて」タブが表示される
    And 「予約確定」タブが表示される
    And 「予約待ち」タブが表示される
    And 「キャンセル」タブが表示される
    And 「完了」タブが表示される

  Scenario: 予約一覧が読み込まれる
    When ページの読み込みが完了する
    Then 予約一覧が表示される、または「予約がありません」が表示される

  Scenario: 予約カードに正しい情報が表示される
    Given 予約が1件以上存在する
    Then 予約カードにステータスバッジが表示される
    And 予約カードにメニューアイコンが表示される
    And 予約カードにスタッフアイコンが表示される
    And 「予約を変更」ボタンが表示される
    And 「キャンセル」ボタンが表示される

  # ステータスフィルタリング
  Scenario: ステータスで予約をフィルタリングできる
    When 「予約確定」タブをクリックする
    Then 「予約確定」タブがアクティブになる

  Scenario: 各ステータスの件数が表示される
    Then 各タブに件数バッジが表示される

  Scenario: フィルタ結果が空の場合に空状態が表示される
    When 「キャンセル」タブをクリックする
    And そのステータスの予約が存在しない
    Then 「予約がありません」または「キャンセルの予約がありません」が表示される

  # 予約変更フロー
  Scenario: 予約編集モーダルを開く
    Given 予約が1件以上存在する
    When 「予約を変更」ボタンをクリックする
    Then 「予約変更」というタイトルのモーダルが表示される
    And カレンダーが表示される
    And メニュー選択ドロップダウンが表示される
    And スタッフ選択ドロップダウンが表示される
    And 備考入力欄が表示される
    And 「予約を更新する」ボタンが表示される

  Scenario: 予約編集モーダルを閉じる
    Given 予約編集モーダルを開いている
    When 閉じるボタンをクリックする
    Then モーダルが閉じる

  Scenario: 予約編集フォームに既存データが事前入力されている
    Given 予約が1件以上存在する
    When 「予約を変更」ボタンをクリックする
    Then メニュー選択に値が入っている
    And スタッフ選択に値が入っている

  Scenario: 編集モーダルで過去の日付が無効化される
    Given 予約編集モーダルを開いている
    Then 過去の日付ボタンが無効化されている

  Scenario: 予約のメニューを変更できる
    Given 予約編集モーダルを開いている
    When 別のメニューを選択する
    Then 新しいメニューが選択される

  Scenario: 予約のスタッフを変更できる
    Given 予約編集モーダルを開いている
    When 別のスタッフを選択する
    Then 新しいスタッフが選択される

  Scenario: 予約の備考を編集できる
    Given 予約編集モーダルを開いている
    When 備考欄を編集する
    Then 新しい備考が入力される

  # 予約キャンセルフロー
  Scenario: 予約キャンセル確認ダイアログを開く
    Given 予約が1件以上存在し、キャンセル可能である
    When 「キャンセル」ボタンをクリックする
    Then 「予約をキャンセルしますか？」というダイアログが表示される
    And 予約日時が表示される
    And メニュー名が表示される
    And 「この操作は取り消せません」という警告が表示される
    And 「戻る」ボタンが表示される
    And 「キャンセルする」ボタンが表示される

  Scenario: キャンセル確認ダイアログを閉じる
    Given キャンセル確認ダイアログを開いている
    When 「戻る」ボタンをクリックする
    Then ダイアログが閉じる

  Scenario: キャンセル確認ダイアログで予約の詳細が表示される
    Given 予約が1件以上存在し、キャンセル可能である
    When 「キャンセル」ボタンをクリックする
    Then 予約日時が表示される
    And メニュー名が表示される
    And 担当者名が表示される
    And 料金が表示される
    And 所要時間が表示される

  Scenario: 過去の予約の編集・キャンセルボタンが無効化される
    Given 過去の予約が存在する
    Then 「予約を変更」ボタンが無効化されている
    And 「キャンセル」ボタンが無効化されている

  # エラーハンドリング
  Scenario: APIエラー時にエラーメッセージが表示される
    Given APIがエラーを返す
    When マイページにアクセスする
    Then 「エラーが発生しました」というメッセージが表示される
    And 「再試行」ボタンが表示される

  Scenario: エラー時に再試行できる
    Given APIがエラーを返している
    And マイページにアクセスしている
    When 「再試行」ボタンをクリックする
    And 2回目のAPIリクエストが成功する
    Then エラーメッセージが消える

  # レスポンシブデザイン
  Scenario: モバイルで正しく表示される
    Given モバイル画面サイズ（375x667）に設定している
    When マイページにアクセスする
    Then タブコンテナがスクロール可能である
    And ページタイトルが表示される

  Scenario: タブレットで正しく表示される
    Given タブレット画面サイズ（768x1024）に設定している
    When マイページにアクセスする
    Then グリッドが2列で表示される

  Scenario: デスクトップで正しく表示される
    Given デスクトップ画面サイズ（1920x1080）に設定している
    When マイページにアクセスする
    Then グリッドが3列で表示される
