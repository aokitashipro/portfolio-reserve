# 並行作業ガイドライン - 4つのworktree運用

## 🎯 目標
- **構築スピード**: 4つのworktreeで並行開発
- **品質担保**: ポートフォリオとして見せられる品質を維持
- **コンフリクト最小化**: スムーズなマージ

---

## ⚠️ 重要な注意事項

### 1. 共有ファイルの取り扱い

#### 🚨 競合リスクが高いファイル（調整必須）

| ファイル | 編集するworktree | 理由 |
|---------|----------------|------|
| `package.json` | **cicd** のみ | 依存関係の追加は1箇所で管理 |
| `prisma/schema.prisma` | **必要なら相談** | スキーマ変更は影響大 |
| `src/lib/prisma.ts` | 編集禁止 | 全worktreeで共有 |
| `tsconfig.json` | **cicd** のみ | 型設定の一貫性 |
| `eslint.config.mjs` | **cicd** のみ | Lint設定の一貫性 |
| `tailwind.config.ts` | 各自OK（最小限） | 共通クラスはドキュメント化 |
| `.env.example` | **cicd** のみ | 環境変数の標準化 |

#### ✅ 各worktreeで自由に編集可能なファイル

- `src/app/**/*` (各自のページ)
- `src/components/**/*` (各自のコンポーネント)
- `src/__tests__/**/*` (各自のテスト)
- `src/lib/` 配下の新規ユーティリティ

---

### 2. ディレクトリ分離戦略

```
src/
├── app/
│   ├── api/               # 既存（全員共有・編集注意）
│   ├── (auth)/            # auth worktree
│   │   ├── register/
│   │   └── login/
│   ├── (admin)/           # admin worktree
│   │   └── admin/
│   │       ├── dashboard/
│   │       └── reservations/
│   ├── (booking)/         # booking worktree
│   │   ├── menus/
│   │   └── booking/
│   └── layout.tsx         # 全員共有・慎重に編集
│
├── components/
│   ├── auth/              # auth worktree
│   ├── admin/             # admin worktree
│   ├── booking/           # booking worktree
│   └── ui/                # 共通コンポーネント（要調整）
│
└── __tests__/
    ├── e2e/
    │   ├── auth/          # auth worktree
    │   ├── admin/         # admin worktree
    │   └── booking/       # booking worktree
```

---

### 3. マージ順序の推奨

```
1️⃣ cicd → main
   ↓ （全員rebase）
2️⃣ auth → main
   ↓ （booking, admin がrebase）
3️⃣ booking → main
   ↓ （admin がrebase）
4️⃣ admin → main
```

**理由:**
- CI/CDを先にマージ → 以降のPRで自動テストが動く
- authを次にマージ → booking, adminで認証機能が使える
- bookingとadminは独立だが、bookingを先にすると総合テストしやすい

---

## 📋 品質チェックリスト（PR作成前）

### ✅ コード品質

- [ ] **ESLintエラー0件** (`npm run lint`)
- [ ] **TypeScriptエラー0件** (`npm run build:ci`)
- [ ] **テストがすべて通る** (`npm test`)
- [ ] **E2Eテストが通る** (`npm run test:e2e`)
- [ ] **コンソールエラー0件** (開発サーバーで確認)

### ✅ テストカバレッジ

- [ ] **単体テスト**: 新規コードの80%以上
- [ ] **E2Eテスト**: 主要フロー100%カバー
- [ ] **エッジケース**: エラーハンドリングのテストあり

### ✅ ポートフォリオとしての見栄え

#### デザイン
- [ ] **レスポンシブ対応**: mobile/tablet/desktop
- [ ] **統一感**: 色・フォント・余白が一貫
- [ ] **アニメーション**: 適度なトランジション（loading, hover）
- [ ] **ダークモード**: （オプション）対応済み

#### UX
- [ ] **ローディング状態**: API呼び出し中にスピナー表示
- [ ] **エラー表示**: ユーザーフレンドリーなメッセージ
- [ ] **成功通知**: トースト/アラートで操作フィードバック
- [ ] **バリデーション**: リアルタイムフォーム検証

#### アクセシビリティ
- [ ] **セマンティックHTML**: `<button>`, `<nav>`, `<main>` 使用
- [ ] **aria-label**: アイコンボタンに説明追加
- [ ] **キーボード操作**: Tab/Enter で操作可能
- [ ] **コントラスト比**: WCAG AA準拠（4.5:1以上）

### ✅ セキュリティ

- [ ] **認証チェック**: 保護ページに未ログインでアクセス不可
- [ ] **CSRF対策**: フォーム送信時にトークン検証
- [ ] **XSS対策**: ユーザー入力をエスケープ
- [ ] **SQL Injection対策**: Prismaを使用（パラメータ化）
- [ ] **環境変数**: 秘密鍵を`.env.local`に配置、`.env.example`に記載

### ✅ パフォーマンス

- [ ] **画像最適化**: Next.js `<Image>` 使用
- [ ] **コード分割**: 動的import `dynamic()` 使用
- [ ] **キャッシング**: `revalidate` 設定済み
- [ ] **バンドルサイズ**: Lighthouse Performanceスコア90以上

### ✅ ドキュメント

- [ ] **README更新**: 新機能の使い方を追記
- [ ] **コメント**: 複雑なロジックに説明追加
- [ ] **型定義**: すべての関数に型注釈
- [ ] **API仕様**: エンドポイントをドキュメント化

---

## 🔄 日次同期フロー

### 毎朝のルーチン（各worktree）

```bash
# 1. mainブランチの最新を取得
cd /Users/a-aoki/indivisual/2026/portpfolio/reserve-system
git checkout main
git pull origin main

# 2. 各worktreeでrebase
cd /Users/a-aoki/indivisual/2026/portpfolio/reserve-system-cicd
git rebase main

cd /Users/a-aoki/indivisual/2026/portpfolio/reserve-system-auth
git rebase main

cd /Users/a-aoki/indivisual/2026/portpfolio/reserve-system-booking
git rebase main

cd /Users/a-aoki/indivisual/2026/portpfolio/reserve-system-admin
git rebase main
```

### コンフリクト発生時

```bash
# コンフリクトを手動解決
# エディタでファイルを編集

git add .
git rebase --continue

# 解決できない場合
git rebase --abort
# Slack/チャットで他のエージェントと調整
```

---

## 🤝 共通コンポーネント管理

### 作成前の確認

新しい共通コンポーネントを作る前に：

1. **既存確認**: `src/components/` に同様のものがないか確認
2. **命名規則**: PascalCase + 明確な名前（例: `BookingCalendar`, `AdminSidebar`）
3. **再利用性**: 3箇所以上で使うならコンポーネント化

### 共通UIコンポーネント

すでに存在するもの（使い回し推奨）:

- `Button.tsx` - 汎用ボタン
- `Card.tsx` - カードコンテナ
- `Header.tsx` - ヘッダー
- `Footer.tsx` - フッター
- `AdminSidebar.tsx` - 管理画面サイドバー

新規作成する場合は `src/components/ui/` に配置。

---

## 🎨 デザイントークン（Tailwind）

### カラーパレット（統一）

```javascript
// tailwind.config.ts に定義済み
primary: '#3B82F6'     // 青（アクション）
secondary: '#8B5CF6'   // 紫（強調）
success: '#10B981'     // 緑（成功）
warning: '#F59E0B'     // 黄（警告）
danger: '#EF4444'      // 赤（エラー）
neutral: '#6B7280'     // グレー（テキスト）
```

### スペーシング規則

```javascript
padding: 'p-4'      // 1rem (16px)
margin: 'm-4'       // 1rem (16px)
gap: 'gap-4'        // グリッド間隔
```

### フォントサイズ

```javascript
text-sm   // 14px（補足）
text-base // 16px（本文）
text-lg   // 18px（小見出し）
text-xl   // 20px（見出し）
text-2xl  // 24px（大見出し）
```

---

## 🧪 テスト戦略

### E2Eテストの分離

```
src/__tests__/e2e/
├── auth.spec.ts        # auth worktree
├── admin.spec.ts       # admin worktree
├── booking.spec.ts     # booking worktree
└── integration.spec.ts # 最後に統合テスト（全員で確認）
```

### モックデータの共有

```typescript
// src/__tests__/mocks/data.ts（全員で共有）
export const mockUser = {
  id: 'test-user-id',
  email: 'test@example.com',
  name: 'テストユーザー',
};

export const mockReservation = {
  id: 'test-reservation-id',
  reservedDate: new Date('2025-01-20'),
  reservedTime: '14:00',
};
```

---

## 📊 PR作成時のテンプレート

```markdown
## 📝 概要
<!-- 何を実装したか -->

## 🎯 関連Issue
Closes #XX

## ✅ チェックリスト
- [ ] ESLint/TypeScriptエラー0件
- [ ] テスト追加（カバレッジ80%以上）
- [ ] E2Eテスト通過
- [ ] レスポンシブ対応
- [ ] アクセシビリティチェック
- [ ] ドキュメント更新

## 🖼️ スクリーンショット
<!-- UI変更があれば貼り付け -->

## 🧪 テスト方法
1. `npm run dev`
2. http://localhost:3000/xxx にアクセス
3. ...

## 💡 レビューポイント
<!-- 特に見てほしい箇所 -->
```

---

## 🚀 デプロイ戦略

### ブランチ別デプロイ（Vercel Preview）

- **main**: 本番環境 (https://reserve-system.vercel.app)
- **PR**: プレビュー環境 (https://reserve-system-pr-123.vercel.app)

### 環境変数の設定

各worktreeで新しい環境変数を追加した場合：

1. `.env.example` に追記（cicd worktreeで）
2. Vercel ダッシュボードに追加
3. GitHub Secretsに追加（CI用）

---

## 📞 コミュニケーション

### 調整が必要な場合

- **共有ファイル編集**: 事前に他のエージェントに通知
- **API変更**: 影響範囲を確認してから実施
- **スキーマ変更**: 全員に影響するため慎重に

### 定期確認（推奨）

- **毎日**: 各worktreeの進捗確認
- **毎日**: mainブランチへのrebase
- **週1回**: 統合テスト実施

---

## 🎯 ゴール

### Week 1終了時点（目標）

- [ ] CI/CD完成（自動テスト動作）
- [ ] ユーザー認証完成（登録・ログイン）
- [ ] 管理者ダッシュボード完成
- [ ] 予約機能完成（カレンダー・登録）

### ポートフォリオとしての完成度

- [ ] **デモ動画**: 主要機能のデモ録画
- [ ] **README充実**: 技術スタック、セットアップ手順
- [ ] **ライブデモ**: Vercelでアクセス可能
- [ ] **テストカバレッジ**: 80%以上
- [ ] **Lighthouseスコア**: 90以上

---

## 📚 参考リンク

- [Next.js ベストプラクティス](https://nextjs.org/docs)
- [Prisma スキーマ設計](https://www.prisma.io/docs/concepts/components/prisma-schema)
- [Tailwind CSS デザインシステム](https://tailwindcss.com/docs)
- [Playwright テストガイド](https://playwright.dev/docs/intro)
- [WCAG アクセシビリティ](https://www.w3.org/WAI/WCAG21/quickref/)

---

**最終更新**: 2025-12-31
**管理者**: Claude Code
