# 予約不可時間帯管理の現状と改善案

**最終更新**: 2026-01-03
**対象**: 外部予約（ホットペッパー・電話予約）対応、予約ブロック機能

---

## 📊 現状の実装確認

### ✅ 実装済みの機能

#### 1. 営業時間設定
**場所:** `/admin/settings` ページ
**設定項目:**
- `openTime`: 開店時刻（例: 09:00）
- `closeTime`: 閉店時刻（例: 20:00）
- `slotDuration`: 予約枠間隔（15分/30分/60分/90分/120分）

**動作:**
- 営業時間外の時間スロットは生成されない
- 閉店時刻を超える予約は不可

**実装:**
```typescript
// api/available-slots/route.ts
const allTimeSlots = generateTimeSlots(
  settings.openTime,
  settings.closeTime,
  settings.slotDuration,
  menu.duration
);
```

#### 2. 定休日設定
**場所:** `/admin/settings` ページ
**設定項目:**
- `closedDays`: 定休日（曜日単位、複数選択可）
  - 例: `["SUNDAY", "MONDAY"]` = 日曜・月曜休み

**動作:**
- 定休日は予約不可
- 空き時間スロットが0件で返却される

**実装:**
```typescript
// api/available-slots/route.ts
const closedDayName = new Date(date).toLocaleDateString('en-US', { weekday: 'long' });
if (settings.closedDays.includes(closedDayName)) {
  return successResponse<AvailableSlots>({
    date,
    slots: [],
  });
}
```

#### 3. スタッフシフト管理（機能フラグ制御）
**場所:** `/admin/staff` ページ
**設定項目:**
- スタッフごとの曜日・時間帯シフト
- 休暇設定（開始日〜終了日）

**動作:**
- シフト管理ONの場合、シフト外の時間は予約不可
- 休暇中のスタッフは予約不可

**実装:**
```typescript
// BookingStaffShift テーブル
model BookingStaffShift {
  dayOfWeek: DayOfWeek  // 曜日
  startTime: String     // 出勤時間（例: "09:00"）
  endTime: String       // 退勤時間（例: "18:00"）
}

// BookingStaffVacation テーブル
model BookingStaffVacation {
  startDate: DateTime   // 休暇開始日
  endDate: DateTime     // 休暇終了日
}
```

#### 4. 既存予約との重複チェック
**動作:**
- 既存予約（`PENDING`, `CONFIRMED`）の時間帯は予約不可
- 予約時間 + メニュー所要時間を考慮した重複チェック

---

## ❌ 不足している機能

### 1. **特定の日時範囲を予約不可にする機能がない**

**問題点:**
- ホットペッパーや電話予約が入った場合、その時間帯をブロックする機能がない
- 臨時休業や特定イベントで予約を停止できない
- 特定の時間帯を「メンテナンス」などでブロックできない

**現状の対処方法（不完全）:**
1. **手動で予約を追加する**
   - 管理画面から「ダミー予約」を作成
   - 問題: 予約データとして残るため、外部予約との区別がつきにくい
   - 問題: 統計データが正確でなくなる

2. **スタッフを休暇設定にする**
   - 全スタッフを休暇にすれば予約不可になる
   - 問題: スタッフ管理機能がOFFの場合は使えない
   - 問題: 一時的なブロックには不向き

### 2. **外部予約の区別ができない**

**問題点:**
- システム経由の予約と外部予約（ホットペッパー、電話）を区別できない
- 予約ソースの分析ができない
- どの経路からの予約が多いか把握できない

### 3. **臨時休業の設定ができない**

**問題点:**
- 定休日は曜日単位のみ（毎週月曜など）
- 特定の日（2026年1月15日のみ休業）を設定できない
- 年末年始、ゴールデンウィークなどの長期休業を設定しにくい

---

## 💡 改善提案

### 提案1: 予約ブロック機能の追加（最優先）✅

**実装内容:**

#### 新しいテーブル: `BookingBlockedTimeSlot`

```prisma
model BookingBlockedTimeSlot {
  id        String   @id @default(uuid())
  tenantId  String   @default("demo-booking") @map("tenant_id")

  startDateTime DateTime @map("start_date_time") // ブロック開始日時
  endDateTime   DateTime @map("end_date_time")   // ブロック終了日時

  reason      String? // 理由（例: "ホットペッパー予約", "電話予約", "臨時休業"）
  description String? // 詳細説明

  createdBy String? @map("created_by") // 作成者（管理者ID）
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([startDateTime, endDateTime])
  @@map("booking_blocked_time_slots")
}
```

#### 管理画面UI

**場所:** `/admin/blocked-times` (新規ページ)

**UI イメージ:**
```
┌─────────────────────────────────────────┐
│ 予約ブロック管理                        │
├─────────────────────────────────────────┤
│ [+ 新規ブロック追加]                    │
├─────────────────────────────────────────┤
│ ブロック一覧                            │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 2026-01-15 14:00 - 15:00           │ │
│ │ 理由: ホットペッパー予約            │ │
│ │ [編集] [削除]                       │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 2026-01-20 09:00 - 18:00           │ │
│ │ 理由: 臨時休業（研修のため）        │ │
│ │ [編集] [削除]                       │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

**追加モーダル:**
```
┌─────────────────────────────────────────┐
│ 予約ブロック追加                        │
├─────────────────────────────────────────┤
│ 開始日時: [2026-01-15] [14:00]         │
│ 終了日時: [2026-01-15] [15:00]         │
│                                         │
│ 理由:                                   │
│ [選択してください ▼]                    │
│   - ホットペッパー予約                  │
│   - 電話予約                            │
│   - 臨時休業                            │
│   - メンテナンス                        │
│   - その他                              │
│                                         │
│ 詳細説明（任意）:                       │
│ [テキストエリア]                        │
│                                         │
│ [キャンセル] [追加]                     │
└─────────────────────────────────────────┘
```

#### 空き時間API修正

**`/api/available-slots` の修正:**

```typescript
// ブロックされた時間帯を取得
const blockedSlots = await prisma.bookingBlockedTimeSlot.findMany({
  where: {
    tenantId: TENANT_ID,
    startDateTime: { lte: new Date(date + 'T23:59:59Z') },
    endDateTime: { gte: new Date(date + 'T00:00:00Z') },
  },
  select: {
    startDateTime: true,
    endDateTime: true,
  },
});

// 各時間スロットがブロックされているかチェック
function isTimeBlocked(
  time: string,
  date: string,
  blockedSlots: { startDateTime: Date; endDateTime: Date }[]
): boolean {
  const [hour, minute] = time.split(':').map(Number);
  const slotDateTime = new Date(date);
  slotDateTime.setHours(hour, minute, 0, 0);

  for (const blocked of blockedSlots) {
    if (slotDateTime >= blocked.startDateTime && slotDateTime < blocked.endDateTime) {
      return true;
    }
  }
  return false;
}

// 時間スロット生成時にブロックチェックを追加
const slots: TimeSlot[] = allTimeSlots.map((time) => {
  // ブロックされている場合は即座にfalse
  if (isTimeBlocked(time, date, blockedSlots)) {
    return { time, available: false };
  }

  // 既存の空き確認ロジック
  // ...
});
```

---

### 提案2: 外部予約管理機能の追加（推奨）

**実装内容:**

#### 予約テーブルに `source` カラムを追加

```prisma
model BookingReservation {
  // 既存カラム
  id: String
  tenantId: String
  userId: String
  // ...

  // 新規カラム
  source: ReservationSource @default(ONLINE) // 予約ソース
  externalId: String? @map("external_id") // 外部システムの予約ID（ホットペッパーのIDなど）
}

enum ReservationSource {
  ONLINE         // システム経由のオンライン予約
  PHONE          // 電話予約
  HOTPEPPER      // ホットペッパー
  WALK_IN        // 飛び込み
  OTHER          // その他
}
```

#### 管理画面での表示

**予約一覧:**
```
┌────────────┬──────────┬────────┬────────┐
│ 予約日時   │ 顧客名   │ メニュー │ ソース │
├────────────┼──────────┼────────┼────────┤
│ 2026-01-15 │ 山田太郎 │ カット │ [オンライン] │
│ 09:00      │          │        │        │
├────────────┼──────────┼────────┼────────┤
│ 2026-01-15 │ 佐藤花子 │ カラー │ [ホットペッパー] │
│ 10:00      │          │        │        │
└────────────┴──────────┴────────┴────────┘
```

**統計分析:**
```
予約ソース別統計
- オンライン: 45件 (60%)
- ホットペッパー: 20件 (27%)
- 電話: 10件 (13%)
```

---

### 提案3: 臨時休業設定機能（オプション）

**実装内容:**

#### 新しいテーブル: `BookingSpecialClosedDay`

```prisma
model BookingSpecialClosedDay {
  id          String   @id @default(uuid())
  tenantId    String   @default("demo-booking") @map("tenant_id")
  closedDate  DateTime @map("closed_date") // 休業日
  reason      String? // 理由（例: "年末年始", "研修日"）
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([closedDate])
  @@map("booking_special_closed_days")
}
```

#### 管理画面UI

**場所:** `/admin/settings` に追加

```
臨時休業設定
┌─────────────────────────────────────────┐
│ [+ 臨時休業を追加]                      │
├─────────────────────────────────────────┤
│ ○ 2026-01-01 - 年末年始 [削除]         │
│ ○ 2026-05-03 - GW休業  [削除]          │
└─────────────────────────────────────────┘
```

---

## 🎯 実装優先度

### Phase 1: 予約ブロック機能（最優先）✅

**理由:**
- ホットペッパー・電話予約への対応が急務
- 実装コストが比較的低い
- 即座に効果が出る

**実装時間:** 6時間
- テーブル追加・マイグレーション: 1時間
- 管理画面UI: 3時間
- 空き時間API修正: 1時間
- テスト: 1時間

**期待効果:**
- ホットペッパー予約との併用が可能に
- 電話予約の管理が容易に
- 臨時休業の設定が簡単に

### Phase 2: 外部予約管理機能（推奨）

**理由:**
- 予約ソースの分析が可能に
- マーケティング施策の効果測定

**実装時間:** 4時間
- テーブル修正・マイグレーション: 1時間
- 管理画面UI: 2時間
- 統計機能: 1時間

### Phase 3: 臨時休業設定（オプション）

**理由:**
- 予約ブロック機能で代替可能
- 優先度は低い

**実装時間:** 3時間

---

## 📊 現状まとめ

### ✅ 実装済み

| 機能 | 設定方法 | 動作 |
|------|---------|------|
| **営業時間設定** | `/admin/settings` | ✅ 営業時間外は予約不可 |
| **定休日設定** | `/admin/settings` | ✅ 曜日単位で予約不可 |
| **スタッフシフト** | `/admin/staff` | ✅ シフト外は予約不可（機能フラグ） |
| **スタッフ休暇** | `/admin/staff` | ✅ 休暇中は予約不可（機能フラグ） |
| **既存予約との重複** | 自動 | ✅ 重複時間帯は予約不可 |

### ❌ 不足している機能

| 機能 | 問題点 | 影響 |
|------|--------|------|
| **予約ブロック機能** | 特定の日時範囲を予約不可にできない | ホットペッパー・電話予約に対応できない |
| **外部予約管理** | 予約ソースを区別できない | 統計分析が不正確 |
| **臨時休業設定** | 特定の日を休業にできない | 年末年始などの設定が煩雑 |

---

## 🚀 推奨アクション

### 最優先: 予約ブロック機能の実装

**実装内容:**
1. `BookingBlockedTimeSlot` テーブル追加
2. 管理画面 `/admin/blocked-times` 作成
3. 空き時間API修正

**期待効果:**
- ✅ ホットペッパー予約との併用可能
- ✅ 電話予約の管理が容易
- ✅ 臨時休業の設定が簡単

### 次点: 外部予約管理機能

**実装内容:**
1. `BookingReservation.source` カラム追加
2. 予約一覧でソース表示
3. 統計分析にソース別集計を追加

**期待効果:**
- ✅ 予約ソースの分析が可能
- ✅ マーケティング施策の効果測定

---

## 🔗 関連ファイル

- `reserve-app/src/app/admin/settings/page.tsx` - 店舗設定ページ
- `reserve-app/src/app/api/available-slots/route.ts` - 空き時間API
- `reserve-app/prisma/schema.prisma` - データベーススキーマ
- `documents/spec/データベース設計書.md` - データベース設計書

---

**このドキュメントは、外部予約（ホットペッパー・電話予約）への対応状況と改善案をまとめたものです。**
